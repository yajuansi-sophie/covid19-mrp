different_result = sum(order_results != igg_order_results),
same_positive_result = sum(order_results == 'Positive' & igg_order_results == 'Positive'),
same_nagative_result = sum(order_results == 'Negative' & igg_order_results == 'Negative')
) %>% kable(digits = 3, caption="When two test results are different for asymptomatic patients")
PCR_prevalence_by_week_symptomatic <- patient_data_symptomatic %>%
filter(!is.na(pcr_week_ind)) %>%
# mutate(pcr_week_ind = as.factor(pcr_week_ind)) %>%
group_by(pcr_week_ind) %>%
summarize(
prevalence = sum(order_results == "Positive")/n(),
total_patient = n()
)
PCR_prevalence_by_week_symptomatic_plot <- ggplot(data =PCR_prevalence_by_week_symptomatic, aes(x = as.numeric(pcr_week_ind),y = prevalence))+
geom_point() +
geom_line()+
scale_x_continuous(breaks=seq(18,30,3))+
labs(title = "Symptomatic Patients", x = "Week", y = "PCR Prevalence")+
scale_y_continuous(expand = c(0, 0), limits = c(0, 0.25))+
scale_x_continuous(breaks=seq(from=19,to=30, by = 1),labels = c("May5 - May11",
"May12 - May18","May19 - May25","May26 - Jun1","Jun2 - Jun8","Jun9 - Jun15","Jun16 - Jun22","Jun23 - Jun29","Jun30 - July6","July7 - July13","July14 - July20",
"July21 - July27"))+
theme_bw()+
theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
PCR_prevalence_by_week_symptomatic_plot
ggsave(PCR_prevalence_by_week_symptomatic_plot, file="plot/pcr-raw-sym.pdf")
IGG_prevalence_by_week_symptomatic <- patient_data_symptomatic %>%
filter(!is.na(igg_week_ind)) %>%
#mutate(igg_week_ind = as.factor(igg_week_ind)) %>%
group_by(igg_week_ind) %>%
summarize(
prevalence = sum(igg_order_results == "Positive")/n(),
total_patient = n()
)
IGG_prevalence_by_week_symptomatic_plot <- ggplot(data =IGG_prevalence_by_week_symptomatic, aes(x = as.numeric(igg_week_ind),y = prevalence))+
geom_point() +
geom_line()+
scale_x_continuous(breaks=seq(18,30,3))+
labs(title = "Symptomatic Patients", x = "Week", y = "IgG Prevalence")+
scale_y_continuous(expand = c(0, 0), limits = c(0, 0.8))+
scale_x_continuous(breaks=seq(from=18,to=30, by = 1),labels = c("Apr28 - May4","May5 - May11",
"May12 - May18","May19 - May25","May26 - Jun1","Jun2 - Jun8","Jun9 - Jun15","Jun16 - Jun22","Jun23 - Jun29","Jun30 - July6","July7 - July13","July14 - July20",
"July21 - July27"))+
theme_bw()+
theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
ggsave(IGG_prevalence_by_week_symptomatic_plot, file="plot/igg-raw-sym")
ggsave(IGG_prevalence_by_week_symptomatic_plot, file="plot/igg-raw-sym.pdf")
patient_data_symptomatic %>%
filter(!is.na(igg_week_ind)) %>%
filter(!is.na(pcr_week_ind)) %>%
summarize(
same_result = sum(order_results == igg_order_results),
different_result = sum(order_results != igg_order_results),
same_positive_result = sum(order_results == 'Positive' & igg_order_results == 'Positive'),
same_nagative_result = sum(order_results == 'Negative' & igg_order_results == 'Negative')
) %>% kable(digits = 3, caption="When two test results are different for symptomatic patients")
grid.arrange(PCR_prevalence_by_week_plot,
IGG_prevalence_by_week_plot,
PCR_prevalence_by_week_symptomatic_plot,
IGG_prevalence_by_week_symptomatic_plot, nrow = 2)
ratio_approximated <- PCR_prevalence_by_week$total_patient[-c(1,14:21)]/ PCR_prevalence_by_week_symptomatic$total_patient
PCR_prevalence_by_week$total_patient
PCR_prevalence_by_week_symptomatic$total_patient
lenght(PCR_prevalence_by_week$total_patient)
length(PCR_prevalence_by_week$total_patient)
length(PCR_prevalence_by_week_symptomatic$total_patient)
ratio_approximated <- PCR_prevalence_by_week$total_patient[2:13]/ PCR_prevalence_by_week_symptomatic$total_patient
count_comparison <- data.frame(PCR_prevalence_by_week$pcr_week_ind[2:13], ratio_approximated)
count_comparison_plot <- ggplot(data =count_comparison, aes(x = count_comparison[,1] ,y =  count_comparison[,2] ))+
geom_point() +
geom_line()+
labs(title = "", x = "Week", y = "Ratio of asymptomatic and symptomatic PCR tests")+
scale_y_continuous(expand = c(0, 0), limits = c(0, 30))+
scale_x_continuous(breaks=seq(from=19,to=30, by = 1),labels = c("May5 - May11",
"May12 - May18","May19 - May25","May26 - Jun1","Jun2 - Jun8","Jun9 - Jun15","Jun16 - Jun22","Jun23 - Jun29","Jun30 - July6","July7 - July13","July14 - July20",
"July21 - July27"))+
theme_bw()+
theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
length(IGG_prevalence_by_week$total_patient)
ggsave(count_comparison_plot, file="pcr_asym_sym_ct.png")
length(IGG_prevalence_by_week$total_patient)
length(IGG_prevalence_by_week_symptomatic$total_patient)
IGG_ratio_approximated <- IGG_prevalence_by_week$total_patient[1:13]/ IGG_prevalence_by_week_symptomatic$total_patient
IGG_count_comparison <- data.frame(IGG_prevalence_by_week$igg_week_ind[1:13], IGG_ratio_approximated)
IGG_count_comparison_plot <- ggplot(data =IGG_count_comparison, aes(x = IGG_count_comparison[,1] ,y =  IGG_count_comparison[,2] ))+
geom_point() +
geom_line()+
labs(title = "", x = "Week", y = "Ratio of asymptomatic and symptomatic IgG tests")+
scale_y_continuous(expand = c(0, 0), limits = c(0, 15))+
scale_x_continuous(breaks=seq(from=18,to=30, by = 1),labels = c("Apr28 - May4","May5 - May11",
"May12 - May18","May19 - May25","May26 - Jun1","Jun2 - Jun8","Jun9 - Jun15","Jun16 - Jun22","Jun23 - Jun29","Jun30 - July6","July7 - July13","July14 - July20",
"July21 - July27"))+
theme_bw()+
theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
ggsave(IGG_count_comparison_plot, file="igg_asym_sym_ct.png")
relative_pct <- patient_data %>%
filter(!is.na(pcr_week_ind)) %>%
mutate(pcr_week_ind = as.factor(pcr_week_ind)) %>%
group_by(pcr_week_ind) %>%
summarize(
pct_male = sum(sex == "Male") / n(),
pct_female = sum(sex == "Female") / n(),
pct_age0_17 = sum(age_stan == 1) / n(),
pct_age18_39 = sum(age_stan == 2) / n(),
pct_age40_64 = sum(age_stan == 3) / n(),
pct_age65_75 = sum(age_stan == 4) / n(),
pct_age75 = sum(age_stan == 5) / n(),
pct_white = sum(race_stan == 1) / n(),
pct_black = sum(race_stan == 2) / n(),
pct_other = sum(race_stan == 3) / n(),
total = n()
)
relative_pct_symptotic <- patient_data_symptomatic %>%
filter(!is.na(pcr_week_ind)) %>%
mutate(pcr_week_ind = as.factor(pcr_week_ind)) %>%
group_by(pcr_week_ind) %>%
summarize(
pct_male = sum(sex == "Male") / n(),
pct_female = sum(sex == "Female") / n(),
pct_age0_17 = sum(age_stan == 1) / n(),
pct_age18_39 = sum(age_stan == 2) / n(),
pct_age40_64 = sum(age_stan == 3) / n(),
pct_age65_75 = sum(age_stan == 4) / n(),
pct_age75 = sum(age_stan == 5) / n(),
pct_white = sum(race_stan == 1) / n(),
pct_black = sum(race_stan == 2) / n(),
pct_other = sum(race_stan == 3) / n(),
total = n()
)
sex_pct <- relative_pct[,1:3] %>%
gather(gender,pct,2:3) %>%
mutate(Gender = ifelse(gender == "pct_male", "male_asym", "female_asym"))
sex_pct_symptotic <- relative_pct_symptotic[,1:3] %>%
gather(gender,pct,2:3) %>%
mutate(Gender = ifelse(gender == "pct_male", "male_sym", "female_sym"))
ggplot()+
geom_point(data =sex_pct, aes(x = pcr_week_ind,y = pct,group = Gender,color = Gender))+
geom_point(data = sex_pct_symptotic, aes(x = pcr_week_ind,y = pct,group = Gender,color = Gender))+
geom_line(data = sex_pct, aes(x = pcr_week_ind,y = pct,group = Gender,color = Gender), linetype = 2)+
geom_line(data = sex_pct_symptotic, aes(x = pcr_week_ind,y = pct,group = Gender,color = Gender), linetype = 1)+
labs (title = "", x = "Week", y = "Proportion")+theme_bw()+
theme(legend.position="bottom",legend.text = element_text(size=8))
race_pct <- relative_pct[,c(1,9:11)] %>%
gather(race,pct,2:4) %>%
mutate(Race = ifelse(race == "pct_white", "white_asym", ifelse(race == "pct_black", "black_asym","other_asym")))
race_pct_symptotic <- relative_pct_symptotic[,c(1,9:11)] %>%
gather(race,pct,2:4) %>%
mutate(Race = ifelse(race == "pct_white", "white_sym", ifelse(race == "pct_black", "black_sym","other_sym")))
ggplot()+
geom_point(data =race_pct , aes(x = pcr_week_ind,y = pct,group = Race,color = Race))+
geom_point(data = race_pct_symptotic, aes(x = pcr_week_ind,y = pct,group = Race,color = Race))+
geom_line(data = race_pct , aes(x = pcr_week_ind,y = pct,group = Race,color = Race), linetype = 2)+
geom_line(data = race_pct_symptotic, aes(x = pcr_week_ind,y = pct,group = Race,color = Race), linetype = 1)+
labs (title = "", x = "Week", y = "Proportion")+
theme_bw()+theme(legend.position="bottom",legend.text = element_text(size=8))
race_pct <- relative_pct[,c(1,9:11)] %>%
gather(race,pct,2:4) %>%
mutate(Race = ifelse(race == "pct_white", "white_asym", ifelse(race == "pct_black", "black_asym","other_asym")))
race_pct_symptotic <- relative_pct_symptotic[,c(1,9:11)] %>%
gather(race,pct,2:4) %>%
mutate(Race = ifelse(race == "pct_white", "white_sym", ifelse(race == "pct_black", "black_sym","other_sym")))
ggplot()+
geom_point(data =race_pct , aes(x = pcr_week_ind,y = pct,group = Race,color = Race))+
geom_point(data = race_pct_symptotic, aes(x = pcr_week_ind,y = pct,group = Race,color = Race))+
geom_line(data = race_pct , aes(x = pcr_week_ind,y = pct,group = Race,color = Race), linetype = 2)+
geom_line(data = race_pct_symptotic, aes(x = pcr_week_ind,y = pct,group = Race,color = Race), linetype = 1)+
labs (title = "", x = "Week", y = "Proportion")+
theme_bw()+theme(legend.position="bottom",legend.text = element_text(size=8))
age_pct <- relative_pct[,c(1,4:8)] %>%
gather(age,pct,2:6) %>%
mutate(Age = ifelse(age == "pct_age0_17", "age0_17_asym", ifelse(age == "pct_age18_39", "age18_39_asym", ifelse(age == "pct_age40_64", "age40_64_asym", ifelse(age == "pct_age65_75", "age65_75_asym","age75_asym" )))))
age_pct_symptotic <- relative_pct_symptotic[,c(1,4:8)] %>%
gather(age,pct,2:6) %>%
mutate(Age = ifelse(age == "pct_age0_17", "age0_17_sym", ifelse(age == "pct_age18_39", "age18_39_sym", ifelse(age == "pct_age40_64", "age40_64_sym", ifelse(age == "pct_age65_75", "age65_75_sym","age75_sym" )))))
ggplot()+
geom_point(data =age_pct , aes(x = pcr_week_ind,y = pct,group = Age,color = Age))+
geom_point(data = age_pct_symptotic, aes(x = pcr_week_ind,y = pct,group = Age,color = Age))+
geom_line(data = age_pct , aes(x = pcr_week_ind,y = pct,group = Age,color = Age), linetype = 2)+
geom_line(data = age_pct_symptotic, aes(x = pcr_week_ind,y = pct,group = Age,color = Age), linetype = 1)+
labs (title = "", x = "Week", y = "Proportion")+ theme_bw()+
theme(legend.position="bottom",legend.text = element_text(size=7))
patient_data = patient_data%>%
mutate(
sex_age = ifelse(sex_stan==-0.5 & age_stan ==1, 1,
ifelse(sex_stan==-0.5 & age_stan ==2, 2,
ifelse(sex_stan==-0.5 & age_stan ==3, 3,
ifelse(sex_stan==-0.5 & age_stan ==4, 4,
ifelse(sex_stan==-0.5 & age_stan ==5, 5,
ifelse(sex_stan==0.5 & age_stan ==1, 6,
ifelse(sex_stan==0.5 & age_stan ==2, 7,
ifelse(sex_stan==0.5 & age_stan ==3, 8,
ifelse(sex_stan==0.5 & age_stan ==3, 9, 10))))))))))
pcr_data_stan <- list(N=dim(patient_data)[1], y=patient_data$y_response,
J_time=length(unique(patient_data$pcr_week_ind)),
male=patient_data$sex_stan, race=as.numeric(patient_data$race_stan), age=as.numeric(patient_data$age_stan),
week=patient_data$pcr_week_ind-17,
county = patient_data$county_stan,
sex_age=patient_data$sex_age,
J_spec=14, y_spec=c(0, 368, 30, 70, 1102, 300, 311, 500, 198, 99, 29, 146, 105, 50), n_spec=c(0, 371, 30, 70, 1102, 300, 311, 500, 200, 99, 31, 150, 108, 52), J_sens=4, y_sens=c(70, 78, 27, 25), n_sens=c(100, 85, 37, 35), logit_spec_prior_scale=0.2, logit_sens_prior_scale=0.2, intercept_prior_mean=0, intercept_prior_scale=2.5, coef_prior_scale=2.5,coef_prior_scale_time=5, J=2*3*5*2, N_pop=poststratification_table_nozip$N, N_acs = county.ps)
patient_data_Andrew = patient_data%>%
mutate(
sex_age = ifelse(sex_stan==0.5 & age_stan ==1, 1,
ifelse(sex_stan==0.5 & age_stan ==2, 2,
ifelse(sex_stan==0.5 & age_stan ==3, 3,
ifelse(sex_stan==0.5 & age_stan ==4, 4, 5)))))
pcr_data_stan_Andrew <- list(N=dim(patient_data_Andrew)[1], y=patient_data_Andrew$y_response,
J_time=length(unique(patient_data_Andrew$pcr_week_ind)),
male=patient_data_Andrew$sex_stan, race=as.numeric(patient_data_Andrew$race_stan), age=as.numeric(patient_data_Andrew$age_stan),
week=patient_data_Andrew$pcr_week_ind-17,
county = patient_data_Andrew$county_stan,
sex_age=patient_data_Andrew$sex_age,
J_spec=14, y_spec=c(0, 368, 30, 70, 1102, 300, 311, 500, 198, 99, 29, 146, 105, 50), n_spec=c(0, 371, 30, 70, 1102, 300, 311, 500, 200, 99, 31, 150, 108, 52), J_sens=4, y_sens=c(70, 78, 27, 25), n_sens=c(100, 85, 37, 35), logit_spec_prior_scale=0.2, logit_sens_prior_scale=0.2, intercept_prior_mean=0, intercept_prior_scale=2.5, coef_prior_scale=2.5,coef_prior_scale_time=5, J=2*3*5*2, N_pop=poststratification_table_nozip$N, N_acs = county.ps)
fit_pcr_918_Yajuan=readRDS("fit_pcr_1005_Yajuan.rds")
fit_pcr_918_Andrew=readRDS("fit_pcr_1005_Andrew.rds")
est_raw_1 = data.frame(cbind(rep(c("Raw","MRP-hospital","MRP-community"),each=length(unique(PCR_prevalence_by_week$pcr_week_ind))),rep(PCR_prevalence_by_week$pcr_week_ind,3),c(PCR_prevalence_by_week$prevalence,apply(rstan::extract(fit_pcr_918_Yajuan,"p_avg_h", permuted = TRUE)[[1]],2,mean),apply(rstan::extract(fit_pcr_918_Yajuan,"p_avg_c", permuted = TRUE)[[1]],2,mean)),c(PCR_prevalence_by_week$prevalence,apply(rstan::extract(fit_pcr_918_Yajuan,"p_avg_h", permuted = TRUE)[[1]],2,quantile, probs=c(0.025)),apply(rstan::extract(fit_pcr_918_Yajuan,"p_avg_c", permuted = TRUE)[[1]],2,quantile, probs=c(0.025))),c(PCR_prevalence_by_week$prevalence,apply(rstan::extract(fit_pcr_918_Yajuan,"p_avg_h", permuted = TRUE)[[1]],2,quantile, probs=c(0.975)),apply(rstan::extract(fit_pcr_918_Yajuan,"p_avg_c", permuted = TRUE)[[1]],2,quantile, probs=c(0.975)))))
names(est_raw_1)=c("type","week","est","low","up")
est_raw_1$week = as.numeric(as.character(est_raw_1$week))
est_raw_1$est = as.numeric(as.character(est_raw_1$est))
est_raw_1$low = as.numeric(as.character(est_raw_1$low))
est_raw_1$up = as.numeric(as.character(est_raw_1$up))
est_raw_1$week
MRP_plot <- ggplot(data=est_raw_1, aes(x=week,y=est,group=type,colour=type))+
geom_point(aes(shape=type))+
geom_line(aes(linetype=type))+
labs (title = "", x = "Week", y = "PCR Prevalence")+
scale_y_continuous(expand = c(0, 0), limits = c(0, 0.05))+
scale_x_continuous(breaks=seq(from=min(est_raw_1$week),to=max(est_raw_1$week), by = 1),labels = c("Apr28 - May4","May5 - May11",
"May12 - May18","May19 - May25","May26 - Jun1","Jun2 - Jun8","Jun9 - Jun15","Jun16 - Jun22","Jun23 - Jun29","Jun30 - July6","July7 - July13","July14 - July20",
"July21 - July27","July28 - Aug3","Aug4 - Aug10","Aug11 - Aug17","Aug18 - Aug24","Aug25 - Aug31","Sep1 - Sep7","Sep8 - Sep14","Sep15 - Sep21", "Sep22 - Sep28", "Sep29 - Oct5"))+
theme_bw()+theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),legend.position="bottom",legend.title=element_blank(),legend.text = element_text(size=9))
mrp_pcr_fit = fit_pcr_918_Andrew
est_raw_1 = data.frame(cbind(rep(c("Raw","MRP-hospital","MRP-community"),each=length(unique(PCR_prevalence_by_week$pcr_week_ind))),rep(PCR_prevalence_by_week$pcr_week_ind,3),c(PCR_prevalence_by_week$prevalence,apply(rstan::extract(mrp_pcr_fit,"p_avg_h", permuted = TRUE)[[1]],2,mean),apply(rstan::extract(mrp_pcr_fit,"p_avg_c", permuted = TRUE)[[1]],2,mean)),c(PCR_prevalence_by_week$prevalence,apply(rstan::extract(mrp_pcr_fit,"p_avg_h", permuted = TRUE)[[1]],2,quantile, probs=c(0.025)),apply(rstan::extract(mrp_pcr_fit,"p_avg_c", permuted = TRUE)[[1]],2,quantile, probs=c(0.025))),c(PCR_prevalence_by_week$prevalence,apply(rstan::extract(mrp_pcr_fit,"p_avg_h", permuted = TRUE)[[1]],2,quantile, probs=c(0.975)),apply(rstan::extract(mrp_pcr_fit,"p_avg_c", permuted = TRUE)[[1]],2,quantile, probs=c(0.975)))))
names(est_raw_1)=c("type","week","est","low","up")
est_raw_1$week = as.numeric(as.character(est_raw_1$week))
est_raw_1$est = as.numeric(as.character(est_raw_1$est))
est_raw_1$low = as.numeric(as.character(est_raw_1$low))
est_raw_1$up = as.numeric(as.character(est_raw_1$up))
MRP_plot <- ggplot(data=est_raw_1, aes(x=week,y=est,group=type,colour=type))+
geom_point(aes(shape=type))+
geom_line(aes(linetype=type))+
labs (title = "", x = "Week", y = "PCR Prevalence")+
scale_y_continuous(expand = c(0, 0), limits = c(0, 0.05))+
scale_x_continuous(breaks=seq(from=min(est_raw_1$week),to=max(est_raw_1$week), by = 1),labels = c("Apr28 - May4","May5 - May11",
"May12 - May18","May19 - May25","May26 - Jun1","Jun2 - Jun8","Jun9 - Jun15","Jun16 - Jun22","Jun23 - Jun29","Jun30 - July6","July7 - July13","July14 - July20",
"July21 - July27","July28 - Aug3","Aug4 - Aug10","Aug11 - Aug17","Aug18 - Aug24","Aug25 - Aug31","Sep1 - Sep7","Sep8 - Sep14","Sep15 - Sep21", "Sep22 - Sep28", "Sep29 - Oct5"))+
theme_bw()+theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),legend.position="bottom",legend.title=element_blank(),legend.text = element_text(size=9))
MRP_CI_plot <- ggplot(data=est_raw_1, aes(x=week,y=est,group=type,colour=type))+
geom_point(aes(shape=type))+
geom_line(aes(linetype=type),alpha=0.4)+
geom_errorbar(aes(ymin=low, ymax=up,linetype=type), width=0.1,alpha=0.4)+
labs (title = "", x = "Week", y = "PCR Prevalence")+
scale_y_continuous(expand = c(0, 0), limits = c(0, 0.1 ))+
scale_x_continuous(breaks=seq(from=min(est_raw_1$week),to=max(est_raw_1$week), by = 1),labels = c("Apr28 - May4","May5 - May11",
"May12 - May18","May19 - May25","May26 - Jun1","Jun2 - Jun8","Jun9 - Jun15","Jun16 - Jun22","Jun23 - Jun29","Jun30 - July6","July7 - July13","July14 - July20",
"July21 - July27","July28 - Aug3","Aug4 - Aug10","Aug11 - Aug17","Aug18 - Aug24","Aug25 - Aug31","Sep1 - Sep7","Sep8 - Sep14","Sep15 - Sep21", "Sep22 - Sep28", "Sep29 - Oct5"))+
theme_bw()+theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),legend.position="bottom",legend.title=element_blank(),legend.text = element_text(size=9))
MRP_plot
MRP_plot <- ggplot(data=est_raw_1, aes(x=week,y=est,group=type,colour=type))+
geom_point(aes(shape=type))+
geom_line(aes(linetype=type))+
labs (title = "", x = "Week", y = "PCR Prevalence")+
scale_y_continuous(expand = c(0, 0), limits = c(0, 0.05))+
scale_x_continuous(breaks=seq(from=min(est_raw_1$week),to=max(est_raw_1$week), by = 1),labels = c("Apr28 - May4","May5 - May11",
"May12 - May18","May19 - May25","May26 - Jun1","Jun2 - Jun8","Jun9 - Jun15","Jun16 - Jun22","Jun23 - Jun29","Jun30 - July6","July7 - July13","July14 - July20",
"July21 - July27","July28 - Aug3","Aug4 - Aug10","Aug11 - Aug17","Aug18 - Aug24","Aug25 - Aug31","Sep1 - Sep7","Sep8 - Sep14","Sep15 - Sep21", "Sep22 - Sep28", "Sep29 - Oct5"))+
theme_bw()+theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),legend.position="bottom",legend.title=element_blank(),legend.text = element_text(size=9))
ggsave(MRP_plot, file="plot/pcr_mrp_est.png")
MRP_CI_plot <- ggplot(data=est_raw_1, aes(x=week,y=est,group=type,colour=type))+
geom_point(aes(shape=type))+
geom_line(aes(linetype=type),alpha=0.4)+
geom_errorbar(aes(ymin=low, ymax=up,linetype=type), width=0.1,alpha=0.4)+
labs (title = "", x = "Week", y = "PCR Prevalence")+
scale_y_continuous(expand = c(0, 0), limits = c(0, 0.1 ))+
scale_x_continuous(breaks=seq(from=min(est_raw_1$week),to=max(est_raw_1$week), by = 1),labels = c("Apr28 - May4","May5 - May11",
"May12 - May18","May19 - May25","May26 - Jun1","Jun2 - Jun8","Jun9 - Jun15","Jun16 - Jun22","Jun23 - Jun29","Jun30 - July6","July7 - July13","July14 - July20",
"July21 - July27","July28 - Aug3","Aug4 - Aug10","Aug11 - Aug17","Aug18 - Aug24","Aug25 - Aug31","Sep1 - Sep7","Sep8 - Sep14","Sep15 - Sep21", "Sep22 - Sep28", "Sep29 - Oct5"))+
theme_bw()+theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),legend.position="bottom",legend.title=element_blank(),legend.text = element_text(size=9))
ggsave(MRP_CI_plot, file="plot/pcr_mrp_ci.png")
patient_data_symptomatic = patient_data_symptomatic%>%
mutate(
sex_age = ifelse(sex_stan==0.5 & age_stan ==1, 1,
ifelse(sex_stan==0.5 & age_stan ==2, 2,
ifelse(sex_stan==0.5 & age_stan ==3, 3,
ifelse(sex_stan==0.5 & age_stan ==4, 4, 5)))))
pcr_data_stan_symptomatic <- list(N=dim(patient_data_symptomatic)[1],
y=patient_data_symptomatic$y_response,
J_time=length(unique(patient_data_symptomatic$pcr_week_ind)),
male=patient_data_symptomatic$sex_stan, race=as.numeric(patient_data_symptomatic$race_stan), age=as.numeric(patient_data_symptomatic$age_stan),
week=patient_data_symptomatic$pcr_week_ind-18,
county = patient_data_symptomatic$county_stan,
sex_age=patient_data_symptomatic$sex_age,
J_spec=14, y_spec=c(0, 368, 30, 70, 1102, 300, 311, 500, 198, 99, 29, 146, 105, 50), n_spec=c(0, 371, 30, 70, 1102, 300, 311, 500, 200, 99, 31, 150, 108, 52), J_sens=4, y_sens=c(70, 78, 27, 25), n_sens=c(100, 85, 37, 35), logit_spec_prior_scale=0.2, logit_sens_prior_scale=0.2, intercept_prior_mean=0, intercept_prior_scale=2.5, coef_prior_scale=2.5,coef_prior_scale_time=5, J=2*3*5*2, N_pop=poststratification_table_nozip$N,
N_acs = county.ps)
fit_pcr_symptomatic=readRDS("fit_pcr_symptomatic0918a.rds")
est_raw_symptomatic = data.frame(cbind(rep(c("Raw","MRP-hospital","MRP-community"),each=length(unique(PCR_prevalence_by_week_symptomatic$pcr_week_ind))),rep(PCR_prevalence_by_week_symptomatic$pcr_week_ind,3),c(PCR_prevalence_by_week_symptomatic$prevalence,apply(rstan::extract(fit_pcr_symptomatic,"p_avg_h", permuted = TRUE)[[1]],2,mean),apply(rstan::extract(fit_pcr_symptomatic,"p_avg_c", permuted = TRUE)[[1]],2,mean)),c(PCR_prevalence_by_week_symptomatic$prevalence,apply(rstan::extract(fit_pcr_symptomatic,"p_avg_h", permuted = TRUE)[[1]],2,quantile, probs=c(0.025)),apply(rstan::extract(fit_pcr_symptomatic,"p_avg_c", permuted = TRUE)[[1]],2,quantile, probs=c(0.025))),c(PCR_prevalence_by_week_symptomatic$prevalence,apply(rstan::extract(fit_pcr_symptomatic,"p_avg_h", permuted = TRUE)[[1]],2,quantile, probs=c(0.975)),apply(rstan::extract(fit_pcr_symptomatic,"p_avg_c", permuted = TRUE)[[1]],2,quantile, probs=c(0.975)))))
names(est_raw_symptomatic)=c("type","week","est","low","up")
est_raw_symptomatic$week = as.numeric(as.character(est_raw_symptomatic$week))
est_raw_symptomatic$est = as.numeric(as.character(est_raw_symptomatic$est))
est_raw_symptomatic$low = as.numeric(as.character(est_raw_symptomatic$low))
est_raw_symptomatic$up = as.numeric(as.character(est_raw_symptomatic$up))
est_raw_symptomatic$week
MRP_symptomatic_plot <- ggplot(data=est_raw_symptomatic, aes(x=week,y=est,group=type,colour=type))+
geom_point(aes(shape=type))+
geom_line(aes(linetype=type))+
labs (title = "", x = "Week", y = "PCR Prevalence for symptomatic patients")+
scale_y_continuous(expand = c(0, 0), limits = c(0, 0.3))+
scale_x_continuous(breaks=seq(from=min(est_raw_symptomatic$week),to=max(est_raw_symptomatic$week), by = 1),labels = c("May5 - May11",
"May12 - May18","May19 - May25","May26 - Jun1","Jun2 - Jun8","Jun9 - Jun15","Jun16 - Jun22","Jun23 - Jun29","Jun30 - July6","July7 - July13","July14 - July20",
"July21 - July27"))+
theme_bw()+theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),legend.position="bottom",legend.title=element_blank(),legend.text = element_text(size=9))
ggsave(MRP_symptomatic_plot, file="plot/pcr_mrp_sym_est.png")
MRP_CI_symptomatic_plot <- ggplot(data=est_raw_symptomatic, aes(x=week,y=est,group=type,colour=type))+
geom_point(aes(shape=type))+
geom_line(aes(linetype=type),alpha=0.4)+
geom_errorbar(aes(ymin=low, ymax=up,linetype=type), width=0.1,alpha=0.4)+
labs (title = "", x = "Week", y = "PCR Prevalence for symptomatic patients")+
scale_y_continuous(expand = c(0, 0), limits = c(0, 0.4))+
scale_x_continuous(breaks=seq(from=19,to=30, by = 1),labels = c("May5 - May11",
"May12 - May18","May19 - May25","May26 - Jun1","Jun2 - Jun8","Jun9 - Jun15","Jun16 - Jun22","Jun23 - Jun29","Jun30 - July6","July7 - July13","July14 - July20",
"July21 - July27"))+
theme_bw()+theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),legend.position="bottom",legend.title=element_blank(),legend.text = element_text(size=9))
ggsave(MRP_CI_symptomatic_plot, file="plot/pcr_mrp_sym_ci.png")
pcr_data_stan_sen55 <- list(N=dim(patient_data_Andrew)[1], y=patient_data_Andrew$y_response,
J_time=length(unique(patient_data_Andrew$pcr_week_ind)),
male=patient_data_Andrew$sex_stan, race=as.numeric(patient_data_Andrew$race_stan), age=as.numeric(patient_data_Andrew$age_stan),
week=patient_data_Andrew$pcr_week_ind-17,
county = patient_data_Andrew$county_stan,
sex_age=patient_data_Andrew$sex_age,
J_spec=14, y_spec=c(0, 368, 30, 70, 1102, 300, 311, 500, 198, 99, 29, 146, 105, 50), n_spec=c(0, 371, 30, 70, 1102, 300, 311, 500, 200, 99, 31, 150, 108, 52), J_sens=4, y_sens=c(55, 78, 27, 25), n_sens=c(100, 85, 37, 35), logit_spec_prior_scale=0.2, logit_sens_prior_scale=0.2, intercept_prior_mean=0, intercept_prior_scale=2.5, coef_prior_scale=2.5,coef_prior_scale_time=5, J=2*3*5*2, N_pop=poststratification_table_nozip$N, N_acs = county.ps)
patient_data_Andrew
pcr_data_stan_sen55 <- list(N=dim(patient_data_Andrew)[1], y=patient_data_Andrew$y_response,
J_time=length(unique(patient_data_Andrew$pcr_week_ind)),
male=patient_data_Andrew$sex_stan, race=as.numeric(patient_data_Andrew$race_stan), age=as.numeric(patient_data_Andrew$age_stan),
week=patient_data_Andrew$pcr_week_ind-17,
county = patient_data_Andrew$county_stan,
sex_age=patient_data_Andrew$sex_age,
J_spec=14, y_spec=c(0, 368, 30, 70, 1102, 300, 311, 500, 198, 99, 29, 146, 105, 50), n_spec=c(0, 371, 30, 70, 1102, 300, 311, 500, 200, 99, 31, 150, 108, 52), J_sens=4, y_sens=c(55, 78, 27, 25), n_sens=c(100, 85, 37, 35), logit_spec_prior_scale=0.2, logit_sens_prior_scale=0.2, intercept_prior_mean=0, intercept_prior_scale=2.5, coef_prior_scale=2.5,coef_prior_scale_time=5, J=2*3*5*2, N_pop=poststratification_table_nozip$N, N_acs = county.ps)
pcr_data_stan_sen60 <- list(N=dim(patient_data_Andrew)[1], y=patient_data_Andrew$y_response,
J_time=length(unique(patient_data_Andrew$pcr_week_ind)),
male=patient_data_Andrew$sex_stan, race=as.numeric(patient_data_Andrew$race_stan), age=as.numeric(patient_data_Andrew$age_stan),
week=patient_data_Andrew$pcr_week_ind-17,
county = patient_data_Andrew$county_stan,
sex_age=patient_data_Andrew$sex_age,
J_spec=14, y_spec=c(0, 368, 30, 70, 1102, 300, 311, 500, 198, 99, 29, 146, 105, 50), n_spec=c(0, 371, 30, 70, 1102, 300, 311, 500, 200, 99, 31, 150, 108, 52), J_sens=4, y_sens=c(60, 78, 27, 25), n_sens=c(100, 85, 37, 35), logit_spec_prior_scale=0.2, logit_sens_prior_scale=0.2, intercept_prior_mean=0, intercept_prior_scale=2.5, coef_prior_scale=2.5,coef_prior_scale_time=5, J=2*3*5*2, N_pop=poststratification_table_nozip$N, N_acs = county.ps)
pcr_data_stan_sen65 <- list(N=dim(patient_data_Andrew)[1], y=patient_data_Andrew$y_response,
J_time=length(unique(patient_data_Andrew$pcr_week_ind)),
male=patient_data_Andrew$sex_stan, race=as.numeric(patient_data_Andrew$race_stan), age=as.numeric(patient_data_Andrew$age_stan),
week=patient_data_Andrew$pcr_week_ind-17,
county = patient_data_Andrew$county_stan,
sex_age=patient_data_Andrew$sex_age,
J_spec=14, y_spec=c(0, 368, 30, 70, 1102, 300, 311, 500, 198, 99, 29, 146, 105, 50), n_spec=c(0, 371, 30, 70, 1102, 300, 311, 500, 200, 99, 31, 150, 108, 52), J_sens=4, y_sens=c(65, 78, 27, 25), n_sens=c(100, 85, 37, 35), logit_spec_prior_scale=0.2, logit_sens_prior_scale=0.2, intercept_prior_mean=0, intercept_prior_scale=2.5, coef_prior_scale=2.5,coef_prior_scale_time=5, J=2*3*5*2, N_pop=poststratification_table_nozip$N, N_acs = county.ps)
IGG_data = patient_data%>%
#filter(!is.na(igg_result))%>%
filter(!is.na(igg_week_ind))%>%
filter(igg_week_ind>20)
IGG_data_stan <- list(N=dim(IGG_data)[1], y=IGG_data$igg_result,
J_time=length(unique(IGG_data$igg_week_ind)),
male=IGG_data$sex_stan, race=as.numeric(IGG_data$race_stan), age=as.numeric(IGG_data$age_stan),
week=IGG_data$igg_week_ind-20, #20,
county = IGG_data$county_stan,
#sex_age=IGG_data$sex_age,
J_spec=14, y_spec=c(0, 368, 30, 70, 1102, 300, 311, 500, 198, 99, 29, 146, 105, 50), n_spec=c(0, 371, 30, 70, 1102, 300, 311, 500, 200, 99, 31, 150, 108, 52), J_sens=4, y_sens=c(70, 78, 27, 25), n_sens=c(100, 85, 37, 35), logit_spec_prior_scale=0.2, logit_sens_prior_scale=0.2, intercept_prior_mean=0, intercept_prior_scale=2.5, coef_prior_scale=1,coef_prior_scale_time=5, J=2*3*5*2, N_pop=poststratification_table_nozip$N, N_acs = county.ps)
fit_IGG = readRDS("fit_igg0918b.rds")
IGG_est_raw = data.frame(cbind(rep(c("Raw","MRP-hospital","MRP-community"),each=length(unique(IGG_prevalence_by_week$igg_week_ind))),rep(IGG_prevalence_by_week$igg_week_ind,3),c(IGG_prevalence_by_week$prevalence,apply(rstan::extract(fit_IGG,"p_avg_h", permuted = TRUE)[[1]],2,mean),apply(rstan::extract(fit_IGG,"p_avg_c", permuted = TRUE)[[1]],2,mean)),c(IGG_prevalence_by_week$prevalence,apply(rstan::extract(fit_IGG,"p_avg_h", permuted = TRUE)[[1]],2,quantile, probs=c(0.025)),apply(rstan::extract(fit_IGG,"p_avg_c", permuted = TRUE)[[1]],2,quantile, probs=c(0.025))),c(IGG_prevalence_by_week$prevalence,apply(rstan::extract(fit_IGG,"p_avg_h", permuted = TRUE)[[1]],2,quantile, probs=c(0.975)),apply(rstan::extract(fit_IGG,"p_avg_c", permuted = TRUE)[[1]],2,quantile, probs=c(0.975)))))
names(IGG_est_raw)=c("type","week","est","low","up")
IGG_est_raw$week = as.numeric(as.character(IGG_est_raw$week))
IGG_est_raw$est = as.numeric(as.character(IGG_est_raw$est))
IGG_est_raw$low = as.numeric(as.character(IGG_est_raw$low))
IGG_est_raw$up = as.numeric(as.character(IGG_est_raw$up))
MRP_IGG_plot <- ggplot(data=IGG_est_raw, aes(x=week,y=est,group=type,colour=type))+
geom_point(aes(shape=type))+
geom_line(aes(linetype=type))+
labs (title = "", x = "Week", y = "IGG Prevalence")+
scale_y_continuous(expand = c(0, 0), limits = c(0, 0.3 ))+
scale_x_continuous(breaks=seq(from=min(IGG_est_raw$week),to=max(IGG_est_raw$week), by = 1),labels = c("Apr28 - May4","May5 - May11",
"May12 - May18","May19 - May25","May26 - Jun1","Jun2 - Jun8","Jun9 - Jun15","Jun16 - Jun22","Jun23 - Jun29","Jun30 - July6","July7 - July13","July14 - July20",
"July21 - July27","July28 - Aug3","Aug4 - Aug10","Aug11 - Aug17","Aug18 - Aug24","Aug25 - Aug31","Sep1 - Sep7","Sep8 - Sep14","Sep15 - Sep21", "Sep22 - Sep28", "Sep29 - Oct5"))+
theme_bw()+theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),legend.position="bottom",legend.title=element_blank(),legend.text = element_text(size=9))
ggsave(MRP_IGG_plot, file="plot/igg_mrp_est.png")
MRP_IGG_CI_plot <- ggplot(data=IGG_est_raw, aes(x=week,y=est,group=type,colour=type))+
geom_point(aes(shape=type))+
geom_line(aes(linetype=type),alpha=0.4)+
geom_errorbar(aes(ymin=low, ymax=up,linetype=type), width=0.1,alpha=0.4)+
labs (title = "", x = "Week", y = "IGG Prevalence")+
scale_y_continuous(expand = c(0, 0), limits = c(0, 0.3 ))+
scale_x_continuous(breaks=seq(from=min(IGG_est_raw$week),to=max(IGG_est_raw$week), by = 1),labels = c("Apr28 - May4","May5 - May11",
"May12 - May18","May19 - May25","May26 - Jun1","Jun2 - Jun8","Jun9 - Jun15","Jun16 - Jun22","Jun23 - Jun29","Jun30 - July6","July7 - July13","July14 - July20",
"July21 - July27","July28 - Aug3","Aug4 - Aug10","Aug11 - Aug17","Aug18 - Aug24","Aug25 - Aug31","Sep1 - Sep7","Sep8 - Sep14","Sep15 - Sep21", "Sep22 - Sep28", "Sep29 - Oct5"))+
theme_bw()+theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),legend.position="bottom",legend.title=element_blank(),legend.text = element_text(size=9))
ggsave(MRP_IGG_CI_plot, file="plot/igg_mrp_ci.png")
IGG_data_symptomatic = patient_data_symptomatic%>%
#filter(!is.na(igg_result))%>%
filter(!is.na(igg_week_ind))
IGG_data_stan_symptomatic <- list(N=dim(IGG_data_symptomatic)[1], y=IGG_data_symptomatic$igg_result,
J_time=length(unique(IGG_data_symptomatic$igg_week_ind)),
male=IGG_data_symptomatic$sex_stan, race=as.numeric(IGG_data_symptomatic$race_stan), age=as.numeric(IGG_data_symptomatic$age_stan),
week=IGG_data_symptomatic$igg_week_ind-17, #20,
county = IGG_data_symptomatic$county_stan,
#sex_age=IGG_data$sex_age,
J_spec=14, y_spec=c(0, 368, 30, 70, 1102, 300, 311, 500, 198, 99, 29, 146, 105, 50), n_spec=c(0, 371, 30, 70, 1102, 300, 311, 500, 200, 99, 31, 150, 108, 52), J_sens=4, y_sens=c(70, 78, 27, 25), n_sens=c(100, 85, 37, 35), logit_spec_prior_scale=0.2, logit_sens_prior_scale=0.2, intercept_prior_mean=0, intercept_prior_scale=2.5, coef_prior_scale=1,coef_prior_scale_time=5, J=2*3*5*2, N_pop=poststratification_table_nozip$N, N_acs = county.ps)
fit_IGG_symptomatic = readRDS("fit_igg_symptomatic0918b.rds")
IGG_est_raw_symptomatic = data.frame(cbind(rep(c("Raw","MRP-hospital","MRP-community"),each=length(unique(IGG_prevalence_by_week_symptomatic$igg_week_ind))),rep(IGG_prevalence_by_week_symptomatic$igg_week_ind,3),c(IGG_prevalence_by_week_symptomatic$prevalence,apply(rstan::extract(fit_IGG_symptomatic,"p_avg_h", permuted = TRUE)[[1]],2,mean),apply(rstan::extract(fit_IGG_symptomatic,"p_avg_c", permuted = TRUE)[[1]],2,mean)),c(IGG_prevalence_by_week_symptomatic$prevalence,apply(rstan::extract(fit_IGG_symptomatic,"p_avg_h", permuted = TRUE)[[1]],2,quantile, probs=c(0.025)),apply(rstan::extract(fit_IGG_symptomatic,"p_avg_c", permuted = TRUE)[[1]],2,quantile, probs=c(0.025))),c(IGG_prevalence_by_week_symptomatic$prevalence,apply(rstan::extract(fit_IGG_symptomatic,"p_avg_h", permuted = TRUE)[[1]],2,quantile, probs=c(0.975)),apply(rstan::extract(fit_IGG_symptomatic,"p_avg_c", permuted = TRUE)[[1]],2,quantile, probs=c(0.975)))))
names(IGG_est_raw_symptomatic)=c("type","week","est","low","up")
IGG_est_raw_symptomatic$week = as.numeric(as.character(IGG_est_raw_symptomatic$week))
IGG_est_raw_symptomatic$est = as.numeric(as.character(IGG_est_raw_symptomatic$est))
IGG_est_raw_symptomatic$low = as.numeric(as.character(IGG_est_raw_symptomatic$low))
IGG_est_raw_symptomatic$up = as.numeric(as.character(IGG_est_raw_symptomatic$up))
mrp_pcr_fit=readRDS("fit_pcr_918_sen55.rds")
est_raw_1 = data.frame(cbind(rep(c("Raw","MRP-hospital","MRP-community"),each=length(unique(PCR_prevalence_by_week$pcr_week_ind))),rep(PCR_prevalence_by_week$pcr_week_ind,3),c(PCR_prevalence_by_week$prevalence,apply(rstan::extract(mrp_pcr_fit,"p_avg_h", permuted = TRUE)[[1]],2,mean),apply(rstan::extract(mrp_pcr_fit,"p_avg_c", permuted = TRUE)[[1]],2,mean)),c(PCR_prevalence_by_week$prevalence,apply(rstan::extract(mrp_pcr_fit,"p_avg_h", permuted = TRUE)[[1]],2,quantile, probs=c(0.025)),apply(rstan::extract(mrp_pcr_fit,"p_avg_c", permuted = TRUE)[[1]],2,quantile, probs=c(0.025))),c(PCR_prevalence_by_week$prevalence,apply(rstan::extract(mrp_pcr_fit,"p_avg_h", permuted = TRUE)[[1]],2,quantile, probs=c(0.975)),apply(rstan::extract(mrp_pcr_fit,"p_avg_c", permuted = TRUE)[[1]],2,quantile, probs=c(0.975)))))
names(est_raw_1)=c("type","week","est","low","up")
est_raw_1$week = as.numeric(as.character(est_raw_1$week))
est_raw_1$est = as.numeric(as.character(est_raw_1$est))
est_raw_1$low = as.numeric(as.character(est_raw_1$low))
est_raw_1$up = as.numeric(as.character(est_raw_1$up))
MRP_plot <- ggplot(data=est_raw_1, aes(x=week,y=est,group=type,colour=type))+
geom_point(aes(shape=type))+
geom_line(aes(linetype=type))+
labs (title = "", x = "Week", y = "PCR Prevalence")+
scale_y_continuous(expand = c(0, 0), limits = c(0, 0.05))+
scale_x_continuous(breaks=seq(from=min(est_raw_1$week),to=max(est_raw_1$week), by = 1),labels = c("Apr28 - May4","May5 - May11",
"May12 - May18","May19 - May25","May26 - Jun1","Jun2 - Jun8","Jun9 - Jun15","Jun16 - Jun22","Jun23 - Jun29","Jun30 - July6","July7 - July13","July14 - July20",
"July21 - July27","July28 - Aug3","Aug4 - Aug10","Aug11 - Aug17","Aug18 - Aug24","Aug25 - Aug31","Sep1 - Sep7","Sep8 - Sep14","Sep15 - Sep21", "Sep22 - Sep28", "Sep29 - Oct5"))+
theme_bw()+theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),legend.position="bottom",legend.title=element_blank(),legend.text = element_text(size=9))
ggsave(MRP_plot, file="plot/pcr_mrp_est_sen55.png")
MRP_CI_plot <- ggplot(data=est_raw_1, aes(x=week,y=est,group=type,colour=type))+
geom_point(aes(shape=type))+
geom_line(aes(linetype=type),alpha=0.4)+
geom_errorbar(aes(ymin=low, ymax=up,linetype=type), width=0.1,alpha=0.4)+
labs (title = "", x = "Week", y = "PCR Prevalence")+
scale_y_continuous(expand = c(0, 0), limits = c(0, 0.1 ))+
scale_x_continuous(breaks=seq(from=min(est_raw_1$week),to=max(est_raw_1$week), by = 1),labels = c("Apr28 - May4","May5 - May11",
"May12 - May18","May19 - May25","May26 - Jun1","Jun2 - Jun8","Jun9 - Jun15","Jun16 - Jun22","Jun23 - Jun29","Jun30 - July6","July7 - July13","July14 - July20",
"July21 - July27","July28 - Aug3","Aug4 - Aug10","Aug11 - Aug17","Aug18 - Aug24","Aug25 - Aug31","Sep1 - Sep7","Sep8 - Sep14","Sep15 - Sep21", "Sep22 - Sep28", "Sep29 - Oct5"))+
theme_bw()+theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),legend.position="bottom",legend.title=element_blank(),legend.text = element_text(size=9))
ggsave(MRP_CI_plot, file="plot/pcr_mrp_ci_sen55.png")
mrp_pcr_fit=readRDS("fit_pcr_918_sen60.rds")
est_raw_1 = data.frame(cbind(rep(c("Raw","MRP-hospital","MRP-community"),each=length(unique(PCR_prevalence_by_week$pcr_week_ind))),rep(PCR_prevalence_by_week$pcr_week_ind,3),c(PCR_prevalence_by_week$prevalence,apply(rstan::extract(mrp_pcr_fit,"p_avg_h", permuted = TRUE)[[1]],2,mean),apply(rstan::extract(mrp_pcr_fit,"p_avg_c", permuted = TRUE)[[1]],2,mean)),c(PCR_prevalence_by_week$prevalence,apply(rstan::extract(mrp_pcr_fit,"p_avg_h", permuted = TRUE)[[1]],2,quantile, probs=c(0.025)),apply(rstan::extract(mrp_pcr_fit,"p_avg_c", permuted = TRUE)[[1]],2,quantile, probs=c(0.025))),c(PCR_prevalence_by_week$prevalence,apply(rstan::extract(mrp_pcr_fit,"p_avg_h", permuted = TRUE)[[1]],2,quantile, probs=c(0.975)),apply(rstan::extract(mrp_pcr_fit,"p_avg_c", permuted = TRUE)[[1]],2,quantile, probs=c(0.975)))))
names(est_raw_1)=c("type","week","est","low","up")
est_raw_1$week = as.numeric(as.character(est_raw_1$week))
est_raw_1$est = as.numeric(as.character(est_raw_1$est))
est_raw_1$low = as.numeric(as.character(est_raw_1$low))
est_raw_1$up = as.numeric(as.character(est_raw_1$up))
MRP_plot <- ggplot(data=est_raw_1, aes(x=week,y=est,group=type,colour=type))+
geom_point(aes(shape=type))+
geom_line(aes(linetype=type))+
labs (title = "", x = "Week", y = "PCR Prevalence")+
scale_y_continuous(expand = c(0, 0), limits = c(0, 0.05))+
scale_x_continuous(breaks=seq(from=min(est_raw_1$week),to=max(est_raw_1$week), by = 1),labels = c("Apr28 - May4","May5 - May11",
"May12 - May18","May19 - May25","May26 - Jun1","Jun2 - Jun8","Jun9 - Jun15","Jun16 - Jun22","Jun23 - Jun29","Jun30 - July6","July7 - July13","July14 - July20",
"July21 - July27","July28 - Aug3","Aug4 - Aug10","Aug11 - Aug17","Aug18 - Aug24","Aug25 - Aug31","Sep1 - Sep7","Sep8 - Sep14","Sep15 - Sep21", "Sep22 - Sep28", "Sep29 - Oct5"))+
theme_bw()+theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),legend.position="bottom",legend.title=element_blank(),legend.text = element_text(size=9))
ggsave(MRP_plot, file="plot/pcr_mrp_est_sen60.png")
MRP_CI_plot <- ggplot(data=est_raw_1, aes(x=week,y=est,group=type,colour=type))+
geom_point(aes(shape=type))+
geom_line(aes(linetype=type),alpha=0.4)+
geom_errorbar(aes(ymin=low, ymax=up,linetype=type), width=0.1,alpha=0.4)+
labs (title = "", x = "Week", y = "PCR Prevalence")+
scale_y_continuous(expand = c(0, 0), limits = c(0, 0.1 ))+
scale_x_continuous(breaks=seq(from=min(est_raw_1$week),to=max(est_raw_1$week), by = 1),labels = c("Apr28 - May4","May5 - May11",
"May12 - May18","May19 - May25","May26 - Jun1","Jun2 - Jun8","Jun9 - Jun15","Jun16 - Jun22","Jun23 - Jun29","Jun30 - July6","July7 - July13","July14 - July20",
"July21 - July27","July28 - Aug3","Aug4 - Aug10","Aug11 - Aug17","Aug18 - Aug24","Aug25 - Aug31","Sep1 - Sep7","Sep8 - Sep14","Sep15 - Sep21", "Sep22 - Sep28", "Sep29 - Oct5"))+
theme_bw()+theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),legend.position="bottom",legend.title=element_blank(),legend.text = element_text(size=9))
ggsave(MRP_CI_plot, file="plot/pcr_mrp_ci_sen60.png")
mrp_pcr_fit=readRDS("fit_pcr_918_sen65.rds")
est_raw_1 = data.frame(cbind(rep(c("Raw","MRP-hospital","MRP-community"),each=length(unique(PCR_prevalence_by_week$pcr_week_ind))),rep(PCR_prevalence_by_week$pcr_week_ind,3),c(PCR_prevalence_by_week$prevalence,apply(rstan::extract(mrp_pcr_fit,"p_avg_h", permuted = TRUE)[[1]],2,mean),apply(rstan::extract(mrp_pcr_fit,"p_avg_c", permuted = TRUE)[[1]],2,mean)),c(PCR_prevalence_by_week$prevalence,apply(rstan::extract(mrp_pcr_fit,"p_avg_h", permuted = TRUE)[[1]],2,quantile, probs=c(0.025)),apply(rstan::extract(mrp_pcr_fit,"p_avg_c", permuted = TRUE)[[1]],2,quantile, probs=c(0.025))),c(PCR_prevalence_by_week$prevalence,apply(rstan::extract(mrp_pcr_fit,"p_avg_h", permuted = TRUE)[[1]],2,quantile, probs=c(0.975)),apply(rstan::extract(mrp_pcr_fit,"p_avg_c", permuted = TRUE)[[1]],2,quantile, probs=c(0.975)))))
names(est_raw_1)=c("type","week","est","low","up")
est_raw_1$week = as.numeric(as.character(est_raw_1$week))
est_raw_1$est = as.numeric(as.character(est_raw_1$est))
est_raw_1$low = as.numeric(as.character(est_raw_1$low))
est_raw_1$up = as.numeric(as.character(est_raw_1$up))
MRP_plot <- ggplot(data=est_raw_1, aes(x=week,y=est,group=type,colour=type))+
geom_point(aes(shape=type))+
geom_line(aes(linetype=type))+
labs (title = "", x = "Week", y = "PCR Prevalence")+
scale_y_continuous(expand = c(0, 0), limits = c(0, 0.05))+
scale_x_continuous(breaks=seq(from=min(est_raw_1$week),to=max(est_raw_1$week), by = 1),labels = c("Apr28 - May4","May5 - May11",
"May12 - May18","May19 - May25","May26 - Jun1","Jun2 - Jun8","Jun9 - Jun15","Jun16 - Jun22","Jun23 - Jun29","Jun30 - July6","July7 - July13","July14 - July20",
"July21 - July27","July28 - Aug3","Aug4 - Aug10","Aug11 - Aug17","Aug18 - Aug24","Aug25 - Aug31","Sep1 - Sep7","Sep8 - Sep14","Sep15 - Sep21", "Sep22 - Sep28", "Sep29 - Oct5"))+
theme_bw()+theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),legend.position="bottom",legend.title=element_blank(),legend.text = element_text(size=9))
ggsave(MRP_plot, file="plot/pcr_mrp_est_sen65.png")
MRP_CI_plot <- ggplot(data=est_raw_1, aes(x=week,y=est,group=type,colour=type))+
geom_point(aes(shape=type))+
geom_line(aes(linetype=type),alpha=0.4)+
geom_errorbar(aes(ymin=low, ymax=up,linetype=type), width=0.1,alpha=0.4)+
labs (title = "", x = "Week", y = "PCR Prevalence")+
scale_y_continuous(expand = c(0, 0), limits = c(0, 0.1 ))+
scale_x_continuous(breaks=seq(from=min(est_raw_1$week),to=max(est_raw_1$week), by = 1),labels = c("Apr28 - May4","May5 - May11",
"May12 - May18","May19 - May25","May26 - Jun1","Jun2 - Jun8","Jun9 - Jun15","Jun16 - Jun22","Jun23 - Jun29","Jun30 - July6","July7 - July13","July14 - July20",
"July21 - July27","July28 - Aug3","Aug4 - Aug10","Aug11 - Aug17","Aug18 - Aug24","Aug25 - Aug31","Sep1 - Sep7","Sep8 - Sep14","Sep15 - Sep21", "Sep22 - Sep28", "Sep29 - Oct5"))+
theme_bw()+theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),legend.position="bottom",legend.title=element_blank(),legend.text = element_text(size=9))
ggsave(MRP_CI_plot, file="plot/pcr_mrp_ci_sen65.png")
mrp_pcr_fit = readRDS("fit_pcr_1005_Andrew.rds")
est_raw_1 = data.frame(cbind(rep(c("Raw","MRP-hospital","MRP-community"),each=length(unique(PCR_prevalence_by_week$pcr_week_ind))),rep(PCR_prevalence_by_week$pcr_week_ind,3),c(PCR_prevalence_by_week$prevalence,apply(rstan::extract(mrp_pcr_fit,"p_avg_h", permuted = TRUE)[[1]],2,mean),apply(rstan::extract(mrp_pcr_fit,"p_avg_c", permuted = TRUE)[[1]],2,mean)),c(PCR_prevalence_by_week$prevalence,apply(rstan::extract(mrp_pcr_fit,"p_avg_h", permuted = TRUE)[[1]],2,quantile, probs=c(0.025)),apply(rstan::extract(mrp_pcr_fit,"p_avg_c", permuted = TRUE)[[1]],2,quantile, probs=c(0.025))),c(PCR_prevalence_by_week$prevalence,apply(rstan::extract(mrp_pcr_fit,"p_avg_h", permuted = TRUE)[[1]],2,quantile, probs=c(0.975)),apply(rstan::extract(mrp_pcr_fit,"p_avg_c", permuted = TRUE)[[1]],2,quantile, probs=c(0.975)))))
names(est_raw_1)=c("type","week","est","low","up")
est_raw_1$week = as.numeric(as.character(est_raw_1$week))
est_raw_1$est = as.numeric(as.character(est_raw_1$est))
est_raw_1$low = as.numeric(as.character(est_raw_1$low))
est_raw_1$up = as.numeric(as.character(est_raw_1$up))
est_raw_1
mrp_pcr_fit=readRDS("fit_pcr_918_sen60.rds")
est_raw_1 = data.frame(cbind(rep(c("Raw","MRP-hospital","MRP-community"),each=length(unique(PCR_prevalence_by_week$pcr_week_ind))),rep(PCR_prevalence_by_week$pcr_week_ind,3),c(PCR_prevalence_by_week$prevalence,apply(rstan::extract(mrp_pcr_fit,"p_avg_h", permuted = TRUE)[[1]],2,mean),apply(rstan::extract(mrp_pcr_fit,"p_avg_c", permuted = TRUE)[[1]],2,mean)),c(PCR_prevalence_by_week$prevalence,apply(rstan::extract(mrp_pcr_fit,"p_avg_h", permuted = TRUE)[[1]],2,quantile, probs=c(0.025)),apply(rstan::extract(mrp_pcr_fit,"p_avg_c", permuted = TRUE)[[1]],2,quantile, probs=c(0.025))),c(PCR_prevalence_by_week$prevalence,apply(rstan::extract(mrp_pcr_fit,"p_avg_h", permuted = TRUE)[[1]],2,quantile, probs=c(0.975)),apply(rstan::extract(mrp_pcr_fit,"p_avg_c", permuted = TRUE)[[1]],2,quantile, probs=c(0.975)))))
names(est_raw_1)=c("type","week","est","low","up")
est_raw_1$week = as.numeric(as.character(est_raw_1$week))
est_raw_1$est = as.numeric(as.character(est_raw_1$est))
est_raw_1$low = as.numeric(as.character(est_raw_1$low))
est_raw_1$up = as.numeric(as.character(est_raw_1$up))
est_raw_1
plot(rstan::extract(mrp_pcr_fit,"p_avg_c", permuted = TRUE)[[1]])
dim(rstan::extract(mrp_pcr_fit,"p_avg_c", permuted = TRUE)[[1]])
est=rstan::extract(mrp_pcr_fit,"p_avg_c", permuted = TRUE)[[1]]
plot(est[,20])
plot(est[,21])
mean(est[,21])
